<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>陀螺仪控制Jeep车</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 800px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        header {
            text-align: center;
            margin-bottom: 20px;
            width: 100%;
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 20px;
        }
        
        .control-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            width: 100%;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .ip-selector {
            display: flex;
            flex-direction: column;
            margin-bottom: 25px;
            width: 100%;
        }
        
        .ip-selector label {
            margin-bottom: 8px;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        #ip-address {
            padding: 12px 15px;
            border-radius: 10px;
            border: none;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            font-size: 1rem;
            width: 100%;
        }
        
        #ip-address option {
            background: #1a2a6c;
            color: white;
        }
        
        .gyro-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .gyro-visualization {
            position: relative;
            width: 250px;
            height: 250px;
            margin: 20px auto;
        }
        
        .gyro-circle {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 3px solid rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .gyro-pointer {
            position: absolute;
            width: 40px;
            height: 40px;
            background: #ff4d4d;
            border-radius: 50%;
            transition: transform 0.1s ease-out;
            box-shadow: 0 0 15px #ff4d4d;
            /* 初始位置在圆心 */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .gyro-axis {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-top: 20px;
        }
        
        .axis {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 10px;
            flex: 1;
            margin: 0 5px;
        }
        
        .axis-value {
            font-size: 1.2rem;
            font-weight: bold;
            margin-top: 5px;
        }
        
        .control-status {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 15px;
            margin-top: 20px;
            text-align: center;
            width: 100%;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .status-active {
            background: #4CAF50;
            box-shadow: 0 0 10px #4CAF50;
        }
        
        .status-inactive {
            background: #f44336;
        }
        
        .command-display {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-family: monospace;
            word-break: break-all;
            width: 100%;
        }
        
        .manual-control {
            display: flex;
            flex-direction: column;
            width: 100%;
            margin-top: 25px;
        }
        
        .manual-control h3 {
            margin-bottom: 15px;
            text-align: center;
        }
        
        .control-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 10px;
            margin: 0 auto;
            width: 200px;
            height: 200px;
        }
        
        .control-btn {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .control-btn:active {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(0.95);
        }
        
        #btn-up {
            grid-column: 2;
            grid-row: 1;
        }
        
        #btn-left {
            grid-column: 1;
            grid-row: 2;
        }
        
        #btn-right {
            grid-column: 3;
            grid-row: 2;
        }
        
        #btn-down {
            grid-column: 2;
            grid-row: 3;
        }
        
        #btn-stop {
            grid-column: 2;
            grid-row: 2;
            background: rgba(255, 0, 0, 0.3);
        }
        
        .instructions {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            margin-top: 25px;
            width: 100%;
        }
        
        .instructions h3 {
            margin-bottom: 15px;
            text-align: center;
        }
        
        .instructions ul {
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 10px;
            line-height: 1.5;
        }
        
        footer {
            margin-top: 30px;
            text-align: center;
            font-size: 0.9rem;
            opacity: 0.7;
            width: 100%;
        }
        
        #gyro-permission-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 1.2rem;
            padding: 12px 24px;
            cursor: pointer;
            margin: 15px auto;
            display: block;
            transition: all 0.3s;
        }
        
        #gyro-permission-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        #gyro-cancel-permission-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 1.2rem;
            padding: 12px 24px;
            cursor: pointer;
            margin: 15px auto;
            display: block;
            transition: all 0.3s;
        }
        
        #gyro-permission-btn:hover,#gyro-cancel-permission-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        @media (max-width: 600px) {
            h1 {
                font-size: 1.8rem;
            }
            
            .gyro-visualization {
                width: 200px;
                height: 200px;
            }
            
            .control-panel {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>陀螺仪控制Jeep车</h1>
            <p class="subtitle">使用手机陀螺仪控制Jeep车移动，通过websocket发动指令。</p>
        </header>
         
        <div class="control-panel">
            <div class="ip-selector">
                <label for="ip-address">选择Jeep车IP地址:</label>
                <input id="ip-address" type="text" value="192.168.4.1">
                <p style="font-size: 12px;">在HTML文件名中增加IP，可修改IP的默认值。</p>
            </div>
            <div class="gyro-container">
                <button id="gyro-permission-btn">启用陀螺仪控制</button>
                <button id="gyro-cancel-permission-btn" style="display: none;">关闭陀螺仪控制</button>
            <!-- 连接按钮和连接状态 -->
            <div id="disconnected-status" class="connection-status disconnected">
                WebSocket未连接，点击连接
            </div>
            <div id="connected-status" class="connection-status connected" style="display: none;">
                WebSocket已连接，点击断开
            </div>

                <div class="gyro-visualization">
                    <div class="gyro-circle"></div>
                    <div class="gyro-pointer" id="gyro-pointer"></div>
                </div>
                <div class="gyro-axis">
                    <div class="axis">
                        <div>X轴 <br />(前后)</div>
                        <div class="axis-value" id="x-value">0.00</div>
                    </div>
                    <div class="axis">
                        <div>Y轴 <br />(左右)</div>
                        <div class="axis-value" id="y-value">0.00</div>
                    </div>
                    <div class="axis">
                        <div>Z轴 <br />(旋转)</div>
                        <div class="axis-value" id="z-value">0.00</div>
                    </div>
                </div>
            </div>
                            <div class="control-status">
                    <span class="status-indicator" id="status-indicator"></span>
                    <span id="status-text">陀螺仪还未授权！</span>
                </div>

            <div class="command-display">
                当前指令: <span id="current-command">stop|stop|-2|-2|-2|-2|</span>
            </div>
        </div>
    </div>

    <script>
        // 从文件名中提取IP地址并设置为默认值
        function setDefaultIPFromFilename() {
            const filename = window.location.pathname.split('/').pop() || document.title;
            const ipMatch = filename.match(/(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})/);
            if (ipMatch && ipMatch[1]) {
                document.getElementById('ip-address').value = ipMatch[1];
            }
        }
        
        // 页面加载完成后设置默认IP
        window.addEventListener('DOMContentLoaded', setDefaultIPFromFilename);

        // 陀螺仪数据变量
        let gyroData = {
            alpha: 0,  // Z轴旋转 (0-360度)
            beta: 0,   // X轴前后倾斜 (-180到180度)
            gamma: 0   // Y轴左右倾斜 (-90到90度)
        };
        // 当前控制状态
        let currentState = {
            command: 'stop|stop|-2|-2|-2|-2|'
        };

        let isGyroActive = false;
        let gyroHandler = null; // 保存陀螺仪事件处理器
        // DOM元素
        const gyroPointer = document.getElementById('gyro-pointer');
        const xValue = document.getElementById('x-value');
        const yValue = document.getElementById('y-value');
        const zValue = document.getElementById('z-value');
        const statusIndicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');
        const currentCommandDisplay = document.getElementById('current-command');
        const gyroPermissionBtn = document.getElementById('gyro-permission-btn');
        const gyroCancelPermissionBtn = document.getElementById('gyro-cancel-permission-btn'); // 新增关闭按钮引用
        
        // 初始化陀螺仪
        function initGyro() {
            if (window.DeviceOrientationEvent) {
                // 请求权限（iOS 13+ 需要）
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    DeviceOrientationEvent.requestPermission()
                        .then(permissionState => {
                            if (permissionState === 'granted') {
                                startGyro();
                            } else {
                                setGyroStatus(false, '陀螺仪权限被拒绝');
                            }
                        })
                        .catch(console.error);
                } else {
                    // 非iOS设备
                    startGyro();
                }
            } else {
                setGyroStatus(false, '设备不支持陀螺仪');
            }
        }
        
        // 启动陀螺仪监听
        function startGyro() {
            gyroHandler = handleOrientation;
            window.addEventListener('deviceorientation', gyroHandler);
            setGyroStatus(true, '陀螺仪已激活');
            gyroPermissionBtn.style.display = 'none'; // 隐藏启用按钮
            gyroCancelPermissionBtn.style.display = 'block'; // 显示关闭按钮
        }
        
        // 停止陀螺仪监听
        function stopGyro() {
            if (gyroHandler) {
                window.removeEventListener('deviceorientation', gyroHandler);
                gyroHandler = null;
            }
            setGyroStatus(false, '陀螺仪已关闭');
            gyroPermissionBtn.style.display = 'block'; // 显示启用按钮
            gyroCancelPermissionBtn.style.display = 'none'; // 隐藏关闭按钮
            
            // 重置指针位置到中心
            gyroPointer.style.transform = 'translate(-50%, -50%)';
            gyroPointer.style.background = '#ff4d4d';
            gyroPointer.style.boxShadow = '0 0 15px #ff4d4d';
            
            // 重置轴值显示
            xValue.textContent = '0.00';
            yValue.textContent = '0.00';
            zValue.textContent = '0.00';
            
            // 发送停止指令
            handleActionWs('stop|stop|-2|-2|-2|-2|');
            currentCommandDisplay.textContent = 'stop|stop|-2|-2|-2|-2|';
        }
        
        // 处理陀螺仪数据
        function handleOrientation(event) {
            gyroData.alpha = event.alpha || 0;  // Z轴旋转
            gyroData.beta = event.beta || 0;    // X轴前后倾斜
            gyroData.gamma = event.gamma || 0;  // Y轴左右倾斜
            // 更新显示
            xValue.textContent = gyroData.beta.toFixed(2);
            yValue.textContent = gyroData.gamma.toFixed(2);
            zValue.textContent = gyroData.alpha.toFixed(2);
            // 更新可视化指针
            updateGyroVisualization();
            // 根据陀螺仪数据生成控制指令
            generateCommandFromGyro();
        }
        
        // 更新陀螺仪可视化
        function updateGyroVisualization() {
            const maxTilt = 90; // 最大倾斜角度
            // 计算指针位置（基于beta和gamma）
            // 将beta(-180~180)和gamma(-90~90)映射到-100%到100%范围
            let xPercent = (gyroData.gamma / maxTilt) * 100;  // 左右倾斜影响X轴
            let yPercent = (gyroData.beta / maxTilt) * 100;   // 前后倾斜影响Y轴
            // 限制在圆圈范围内
            const distance = Math.sqrt(xPercent*xPercent + yPercent*yPercent);
            if (distance > 100) {
                xPercent = (xPercent / distance) * 100;
                yPercent = (yPercent / distance) * 100;
            }
            // 更新指针位置 (使用transform translate)
            // 修改: 使用translate的百分比相对于容器大小
            gyroPointer.style.transform = `translate(calc(-50% + ${xPercent}%),calc(-50% + ${yPercent}%))`;
            //根据位置改变颜色
            if (distance > 70) {
                gyroPointer.style.background = '#ff0000';
                gyroPointer.style.boxShadow = '0 0 20px #ff0000';
            } else if (distance > 40) {
                gyroPointer.style.background = '#ffaa00';
                gyroPointer.style.boxShadow = '0 0 15px #ffaa00';
            } else {
                gyroPointer.style.background = '#4CAF50';
                gyroPointer.style.boxShadow = '0 0 10px #4CAF50';
            }
        }
        // 根据陀螺仪数据生成控制指令并发送指令
        function generateCommandFromGyro() {
            X_axis = gyroData.beta;
            Y_axis = gyroData.gamma;
            if (X_axis > 20) {
                channle_1 = "bottom"
            } else if (X_axis < -20) {
                channle_1 = "top"
            }  else {
                channle_1 = "stop"
            }
            if (Y_axis > 20) {
                channle_2 = "right"
            } else if (Y_axis < -20) {
                channle_2 = "left"
            } else {
                channle_2 = "stop"
            }
            handleActionWs(channle_1+"|"+channle_2+"|-2|-2|-2|-2|")
            // 更新显示
            currentCommandDisplay.textContent = channle_1+"|"+channle_2+"|-2|-2|-2|-2|";
        }
        // 设置陀螺仪状态
        function setGyroStatus(active, message) {
            isGyroActive = active;
            statusIndicator.className = active ? 'status-indicator status-active' : 'status-indicator status-inactive';
            statusText.textContent = message;
        }
        // WebSocket相关变量
        let ws = null;
        let isConnected = false;
        
        // 更新连接状态显示
        function updateConnectionStatus(status) {
            const disconnectedstatusElement = document.getElementById('disconnected-status');
            const connectedstatusElement = document.getElementById('connected-status');
            if (status) {
                disconnectedstatusElement.style.display = 'none';
                connectedstatusElement.style.display = 'block';
            } else {
                disconnectedstatusElement.style.display = 'block';
                connectedstatusElement.style.display = 'none';
            }
        }
        
        // 连接WebSocket
        function connectWebSocket() {
            // 切换连接状态，如果已连接，调用该方法时，则断开
            if (ws) {
                ws.close();
                ws = null;
                isConnected = false;
                updateConnectionStatus(false);
                return;
            }
            
            const ip = document.getElementById('ip-address').value;
            if (!ip) {
                alert('请输入IP地址');
                return;
            }
            
            try {
                ws = new WebSocket(`ws://${ip}:8080`);
                
                ws.onopen = function() {
                    console.log('WebSocket连接已建立');
                    isConnected = true;
                    updateConnectionStatus(true);
                };
                
                ws.onmessage = function(event) {
                    console.log('收到消息:', event.data);
                };
                
                ws.onclose = function() {
                    console.log('WebSocket连接已关闭');
                    ws = null;
                    isConnected = false;
                    updateConnectionStatus(false);
                };
                
                ws.onerror = function(error) {
                    console.error('WebSocket错误:', error);
                    ws = null;
                    isConnected = false;
                    updateConnectionStatus(false);
                    alert('连接失败');
                };
                
            } catch (e) {
                console.error('WebSocket连接失败:', e);
                alert('连接失败: ' + e.message);
            }
        }
        
        // 发送WebSocket消息
        function sendWebSocketMessage(command) {
            if (!isConnected || !ws) {
                console.log('WebSocket未连接');
                return false;
            }
            
            try {
                ws.send(command);
                return true;
            } catch (e) {
                console.error('发送消息失败:', e);
                return false;
            }
        }
        function handleActionWs(command) {
            // 移除command:前缀（如果存在）
            if (command.startsWith('control:')) {
                command = command.substring(8); // 移除'control:'前缀
            }
            
            if (currentState.command !== command) {
                currentState.command = command;
                // 更新显示的指令
                document.getElementById('current-command').textContent = command;
                
                // 通过WebSocket发送命令
                if (!sendWebSocketMessage('control:' + command)) {
                    console.log('WebSocket发送失败');
                }
            }
        }

        // 初始化陀螺仪，按钮点击事件
        gyroPermissionBtn.addEventListener('click', initGyro);
        gyroCancelPermissionBtn.addEventListener('click', stopGyro); // 添加关闭按钮事件监听
        // 绑定连接按钮事件
        document.getElementById('disconnected-status').addEventListener('click', connectWebSocket);
        document.getElementById('connected-status').addEventListener('click', connectWebSocket);
    </script>
</body>
</html>